#
# dotfiles
# Sync WARP VM's dotfiles
#

name: Sync dotfiles on WARP
on:
  push: {}
    #branches: [main]
jobs:
  create-warp-pr:
    name: Create PR to update dotfiles in WARP Box
    runs-on: ubuntu-22.04
    env:
      WARP_REPO: mrzzy/warp
      COMMIT_USER: github-actions[bot]
      COMMIT_EMAIL: github-actions[bot]@users.noreply.github.com
      BRANCH: build/update-dotfiles
    steps:
      - name: Clone WARP repository
        uses: actions/checkout@v3
        with:
          repository: ${{ env.WARP_REPO }}
          token: ${{ secrets.GH_PUSH_TOKEN }}

      - name: Push updated mrzzy/dotfiles commit hash
        run: |
          set -ex -o pipefail

          # update hash in devbox playbook to use latest dotfiles
          DEFAULT_VARS=box/ansible/roles/devbox/defaults/main.yaml
          git switch -c ${BRANCH}
          sed -i -e '/devbox_dotfiles_rev:/s/[^ ]\+$/${{ github.sha }}/' ${DEFAULT_VARS}

          # commit & changes to dotfiles commit hash
          git config user.name ${COMMIT_USER}
          git config user.email ${COMMIT_EMAIL}
          git commit -m "build(ansible): update revision of dotfiles installed" ${DEFAULT_VARS}
          git push -u https://github.com/${WARP_REPO} +${BRANCH}

      - name: Apply Pull Request (PR) to Update Dotfiles
        uses: actions/github-script@v6.1.0
        with:
          script: |
            const {data: prs} = await github.rest.pulls.list({
              owner: "mrzzy",
              repo: "warp",
              base: "${{ env.BRANCH }}"
            });
            return `PRs:${prs}`;
          result-encoding: string
